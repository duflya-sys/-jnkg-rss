name: æ™‹èƒ½æ§è‚¡æ‹›æ ‡æ•°æ®è‡ªåŠ¨æŠ“å–

on:
  schedule:
    # æ¯å‘¨ä¸‰å’Œå‘¨äº”çš„18:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    # GitHub Actions ä½¿ç”¨ UTC æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ 18:00 = UTC 10:00
    - cron: '0 10 * * 3,5'
  
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      days_limit:
        description: 'æŠ“å–å¤©æ•°é™åˆ¶'
        required: false
        default: '10'
        type: string

jobs:
  crawl-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # è®¾ç½®è¶…æ—¶æ—¶é—´
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        # å®‰è£…ç½‘ç»œæµ‹è¯•å·¥å…·
        pip install ping3
        
    - name: ç½‘ç»œè¿é€šæ€§æµ‹è¯•
      run: |
        echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿é€šæ€§..."
        echo "1. æµ‹è¯•ç™¾åº¦..."
        curl -I --connect-timeout 10 https://www.baidu.com || echo "ç™¾åº¦è¿æ¥å¤±è´¥"
        
        echo "2. æµ‹è¯•ç›®æ ‡ç½‘ç«™..."
        curl -I --connect-timeout 10 https://dzzb.jnkgjtdzzbgs.com || echo "ç›®æ ‡ç½‘ç«™ç›´æ¥è¿æ¥å¤±è´¥"
        
        echo "3. æµ‹è¯•ä»£ç†æœåŠ¡å™¨..."
        # æµ‹è¯•ä»£ç†æ˜¯å¦å¯ç”¨
        timeout 10 curl -x http://117.69.236.166:8089 -I https://www.baidu.com || echo "ä»£ç†æµ‹è¯•å¤±è´¥"
    
    - name: è¿è¡Œæ•°æ®æŠ“å–ä»»åŠ¡
      env:
        FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_APP_TOKEN: ${{ secrets.FEISHU_APP_TOKEN }}
        FEISHU_TABLE_ID: ${{ secrets.FEISHU_TABLE_ID }}
        FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        GITHUB_ACTIONS: 'true'  # å‘Šè¯‰çˆ¬è™«è¿™æ˜¯GitHub Actionsç¯å¢ƒ
      run: |
        echo "ğŸ•·ï¸ å¼€å§‹æ‰§è¡Œæ™‹èƒ½æ§è‚¡æ‹›æ ‡æ•°æ®æŠ“å–..."
        echo "å½“å‰æ—¶é—´: $(date)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        echo "ç¯å¢ƒå˜é‡æ£€æŸ¥:"
        echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
        
        echo "è¿è¡Œä¸»ç¨‹åº..."
        python main.py
        
        echo "ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
        echo "å½“å‰æ—¶é—´: $(date)"
    
    - name: ä¸Šä¼ æŠ“å–æ—¥å¿—å’Œå¤‡ä»½æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: crawl-data-${{ github.run_number }}
        path: |
          *.log
          *.csv
          bidding_crawler.log
        retention-days: 7
